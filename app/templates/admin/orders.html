{% extends "base.html" %}

{% block title %}Gesti√≥n de Pedidos{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Gesti√≥n de Pedidos</h1>
    <p class="text-gray-600">Administra los pedidos recibidos a trav√©s del asistente virtual</p>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    {% set new_orders = orders | selectattr("status", "equalto", "new") | list %}
    {% set confirmed_orders = orders | selectattr("status", "equalto", "confirmed") | list %}
    {% set fulfilled_orders = orders | selectattr("status", "equalto", "fulfilled") | list %}
    {% set cancelled_orders = orders | selectattr("status", "equalto", "cancelled") | list %}
    
    <div class="bg-white p-6 rounded-xl shadow-sm">
        <div class="flex items-center">
            <div class="text-3xl text-blue-500 mr-4">üÜï</div>
            <div>
                <p class="text-2xl font-bold text-gray-900">{{ new_orders | length }}</p>
                <p class="text-sm text-gray-600">Nuevos</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white p-6 rounded-xl shadow-sm">
        <div class="flex items-center">
            <div class="text-3xl text-yellow-500 mr-4">‚è≥</div>
            <div>
                <p class="text-2xl font-bold text-gray-900">{{ confirmed_orders | length }}</p>
                <p class="text-sm text-gray-600">Confirmados</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white p-6 rounded-xl shadow-sm">
        <div class="flex items-center">
            <div class="text-3xl text-green-500 mr-4">‚úÖ</div>
            <div>
                <p class="text-2xl font-bold text-gray-900">{{ fulfilled_orders | length }}</p>
                <p class="text-sm text-gray-600">Completados</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white p-6 rounded-xl shadow-sm">
        <div class="flex items-center">
            <div class="text-3xl text-red-500 mr-4">‚ùå</div>
            <div>
                <p class="text-2xl font-bold text-gray-900">{{ cancelled_orders | length }}</p>
                <p class="text-sm text-gray-600">Cancelados</p>
            </div>
        </div>
    </div>
</div>

<!-- Filter and Actions -->
<div class="bg-white p-6 rounded-xl shadow-sm mb-8">
    <div class="flex flex-wrap gap-4 items-center justify-between">
        <div class="flex gap-2">
            <button onclick="filterOrders('all')" class="filter-btn active px-4 py-2 rounded-lg bg-blue-50 text-blue-600">
                Todos ({{ orders | length }})
            </button>
            <button onclick="filterOrders('new')" class="filter-btn px-4 py-2 rounded-lg hover:bg-gray-50">
                Nuevos ({{ new_orders | length }})
            </button>
            <button onclick="filterOrders('confirmed')" class="filter-btn px-4 py-2 rounded-lg hover:bg-gray-50">
                Confirmados ({{ confirmed_orders | length }})
            </button>
        </div>
        
        <div class="flex gap-2">
            <button onclick="exportOrders()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                üì• Exportar CSV
            </button>
            <button onclick="refreshOrders()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                üîÑ Actualizar
            </button>
        </div>
    </div>
</div>

<!-- Orders List -->
<div class="space-y-4">
    {% if orders %}
        {% for order in orders %}
        <div class="order-item bg-white p-6 rounded-xl shadow-sm border-l-4 
            {% if order.status == 'new' %}border-blue-500
            {% elif order.status == 'confirmed' %}border-yellow-500
            {% elif order.status == 'fulfilled' %}border-green-500
            {% else %}border-red-500{% endif %}" 
            data-status="{{ order.status }}">
            
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <div class="flex items-center mb-2">
                        <h3 class="text-lg font-semibold text-gray-900">Pedido #{{ order.id }}</h3>
                        <span class="ml-3 px-3 py-1 rounded-full text-sm
                            {% if order.status == 'new' %}bg-blue-100 text-blue-800
                            {% elif order.status == 'confirmed' %}bg-yellow-100 text-yellow-800
                            {% elif order.status == 'fulfilled' %}bg-green-100 text-green-800
                            {% else %}bg-red-100 text-red-800{% endif %}">
                            {{ order.status.title() }}
                        </span>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-sm text-gray-600">Cliente</p>
                            <p class="font-medium">{{ order.customer_name }}</p>
                            {% if order.phone %}
                            <p class="text-sm text-gray-600">üìû {{ order.phone }}</p>
                            {% endif %}
                        </div>
                        
                        <div>
                            <p class="text-sm text-gray-600">Canal y Fecha</p>
                            <p class="font-medium">{{ order.channel.title() }}</p>
                            <p class="text-sm text-gray-600">{{ order.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                        </div>
                    </div>
                    
                    <!-- Order Items -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold mb-2">Productos Solicitados</h4>
                        {% set items = order.items_json | from_json %}
                        {% if items %}
                            {% for item in items %}
                            <div class="flex justify-between py-1">
                                <span>{{ item.qty }}x {{ item.name }}</span>
                                <span class="font-medium">${{ "%.2f"|format(item.price * item.qty) }}</span>
                            </div>
                            {% endfor %}
                            <div class="border-t pt-2 mt-2">
                                <div class="flex justify-between font-semibold">
                                    <span>Total:</span>
                                    <span>${{ "%.2f"|format(order.total) }}</span>
                                </div>
                            </div>
                        {% else %}
                            <p class="text-gray-600">Informaci√≥n de pedido: {{ order.items_json }}</p>
                        {% endif %}
                    </div>
                    
                    {% if order.notes %}
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <p class="text-sm text-blue-800"><strong>Notas:</strong> {{ order.notes }}</p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Actions -->
                <div class="flex flex-col space-y-2 ml-4">
                    {% if order.status == 'new' %}
                    <button onclick="updateOrderStatus({{ order.id }}, 'confirmed')" 
                            class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 text-sm">
                        ‚úÖ Confirmar
                    </button>
                    <button onclick="updateOrderStatus({{ order.id }}, 'cancelled')" 
                            class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm">
                        ‚ùå Cancelar
                    </button>
                    {% elif order.status == 'confirmed' %}
                    <button onclick="updateOrderStatus({{ order.id }}, 'fulfilled')" 
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                        üöö Marcar Listo
                    </button>
                    <button onclick="updateOrderStatus({{ order.id }}, 'cancelled')" 
                            class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm">
                        ‚ùå Cancelar
                    </button>
                    {% endif %}
                    
                    {% if order.phone %}
                    <a href="tel:{{ order.phone }}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm text-center">
                        üìû Llamar
                    </a>
                    {% endif %}
                    
                    {% if order.phone and order.phone.startswith('+') %}
                    <a href="https://wa.me/{{ order.phone.replace('+', '').replace(' ', '').replace('-', '') }}" 
                       target="_blank" 
                       class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm text-center">
                        üíö WhatsApp
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="bg-white rounded-xl shadow-sm p-12 text-center">
        <div class="text-6xl mb-4">üìã</div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No hay pedidos a√∫n</h3>
        <p class="text-gray-600 mb-6">Los pedidos que hagan los clientes a trav√©s del bot aparecer√°n aqu√≠</p>
        
        <div class="flex justify-center space-x-4">
            <a href="/admin/playground" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                üß™ Probar Bot
            </a>
            <a href="/demo" target="_blank" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700">
                üí¨ Ver Demo
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
async function updateOrderStatus(orderId, newStatus) {
    const statusNames = {
        'confirmed': 'confirmar',
        'fulfilled': 'marcar como listo',
        'cancelled': 'cancelar'
    };
    
    if (confirm(`¬øEst√°s seguro que quer√©s ${statusNames[newStatus]} este pedido?`)) {
        try {
            const response = await fetch(`/api/orders/${orderId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            
            if (response.ok) {
                location.reload();
            } else {
                alert('Error al actualizar el pedido');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
}

function filterOrders(status) {
    const items = document.querySelectorAll('.order-item');
    const buttons = document.querySelectorAll('.filter-btn');
    
    // Update button states
    buttons.forEach(btn => btn.classList.remove('active', 'bg-blue-50', 'text-blue-600'));
    event.target.classList.add('active', 'bg-blue-50', 'text-blue-600');
    
    // Filter items
    items.forEach(item => {
        if (status === 'all' || item.dataset.status === status) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function exportOrders() {
    window.location.href = '/api/orders/export';
}

function refreshOrders() {
    location.reload();
}
</script>

<!-- Custom filter for parsing JSON in Jinja2 -->
{% set from_json = {"from_json": lambda x: x | replace("'", '"') | from_json} %}

{% endblock %}