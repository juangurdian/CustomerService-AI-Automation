{% extends "base.html" %}

{% block title %}Playground - Probar Bot{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Playground - Probar Bot</h1>
    <p class="text-gray-600">Prueba tu asistente virtual y ve c√≥mo responde en tiempo real</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Chat Interface -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-sm h-96 flex flex-col">
            <div class="p-4 border-b bg-gray-50 rounded-t-xl">
                <h3 class="font-semibold text-gray-800">üí¨ Chat de Prueba</h3>
                <p class="text-sm text-gray-600">Simula una conversaci√≥n con tu bot</p>
            </div>
            
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4 bg-gray-50">
                <div class="flex justify-start">
                    <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg bg-white shadow-sm">
                        <p class="text-sm">¬°Hola! Soy el asistente virtual de {{ config.business.name }}. ¬øEn qu√© te puedo ayudar?</p>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t">
                <div class="flex space-x-2">
                    <input 
                        type="text" 
                        id="message-input" 
                        placeholder="Escribe tu mensaje..."
                        class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onkeypress="handleKeyPress(event)"
                    >
                    <button 
                        onclick="sendMessage()" 
                        class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700"
                    >
                        Enviar
                    </button>
                </div>
                
                <!-- Quick Reply Buttons -->
                <div id="quick-replies" class="mt-3 flex flex-wrap gap-2"></div>
            </div>
        </div>
    </div>
    
    <!-- Debug Panel -->
    <div class="bg-white rounded-xl shadow-sm">
        <div class="p-4 border-b bg-gray-50 rounded-t-xl">
            <h3 class="font-semibold text-gray-800">üîç Debug Info</h3>
            <p class="text-sm text-gray-600">Informaci√≥n t√©cnica de la √∫ltima respuesta</p>
        </div>
        
        <div class="p-4">
            <div id="debug-info" class="text-sm">
                <p class="text-gray-500 italic">Env√≠a un mensaje para ver informaci√≥n de debug</p>
            </div>
        </div>
    </div>
</div>

<!-- Test Scenarios -->
<div class="mt-8 bg-white p-6 rounded-xl shadow-sm">
    <h3 class="text-lg font-semibold mb-4">üß™ Escenarios de Prueba</h3>
    <p class="text-gray-600 mb-4">Haz clic en estos ejemplos para probar diferentes funcionalidades:</p>
    
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <button onclick="testMessage('Hola')" class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 text-left">
            <div class="font-medium">Saludo</div>
            <div class="text-sm text-gray-600">"Hola"</div>
        </button>
        
        <button onclick="testMessage('¬øCu√°les son sus horarios?')" class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 text-left">
            <div class="font-medium">FAQ</div>
            <div class="text-sm text-gray-600">Horarios</div>
        </button>
        
        <button onclick="testMessage('¬øQu√© tienen en el men√∫?')" class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 text-left">
            <div class="font-medium">Men√∫</div>
            <div class="text-sm text-gray-600">Ver productos</div>
        </button>
        
        <button onclick="testMessage('Quiero hacer un pedido')" class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 text-left">
            <div class="font-medium">Pedido</div>
            <div class="text-sm text-gray-600">Flujo de orden</div>
        </button>
    </div>
</div>

<script>
const chatMessages = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const quickReplies = document.getElementById('quick-replies');
const debugInfo = document.getElementById('debug-info');

// Generate a simple user ID for testing
const testUserId = 'test_user_' + Math.random().toString(36).substr(2, 9);

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function testMessage(text) {
    messageInput.value = text;
    sendMessage();
}

async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;
    
    // Add user message to chat
    addMessageToChat(text, 'user');
    messageInput.value = '';
    
    // Clear quick replies
    quickReplies.innerHTML = '';
    
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                channel: 'web',
                user_id: testUserId,
                text: text
            })
        });
        
        const result = await response.json();
        
        // Add bot response
        addMessageToChat(result.reply, 'bot');
        
        // Add quick replies
        if (result.quick_replies && result.quick_replies.length > 0) {
            showQuickReplies(result.quick_replies);
        }
        
        // Update debug info
        updateDebugInfo(result.trace);
        
    } catch (error) {
        addMessageToChat('Error: No se pudo enviar el mensaje', 'error');
        console.error('Error:', error);
    }
}

function addMessageToChat(text, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex ' + (type === 'user' ? 'justify-end' : 'justify-start');
    
    const bubble = document.createElement('div');
    bubble.className = 'max-w-xs lg:max-w-md px-4 py-2 rounded-lg ';
    
    if (type === 'user') {
        bubble.className += 'bg-blue-600 text-white';
    } else if (type === 'error') {
        bubble.className += 'bg-red-100 text-red-800 border border-red-200';
    } else {
        bubble.className += 'bg-white shadow-sm';
    }
    
    bubble.innerHTML = `<p class="text-sm">${text}</p>`;
    messageDiv.appendChild(bubble);
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showQuickReplies(replies) {
    quickReplies.innerHTML = '';
    replies.forEach(reply => {
        const button = document.createElement('button');
        button.className = 'px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200';
        button.textContent = reply;
        button.onclick = () => {
            messageInput.value = reply;
            sendMessage();
        };
        quickReplies.appendChild(button);
    });
}

function updateDebugInfo(trace) {
    const html = `
        <div class="space-y-2">
            <div>
                <span class="font-semibold">Intenci√≥n:</span>
                <span class="text-blue-600">${trace.intent || 'N/A'}</span>
            </div>
            <div>
                <span class="font-semibold">Fuente:</span>
                <span class="text-green-600">${trace.source || 'N/A'}</span>
            </div>
            <div>
                <span class="font-semibold">Confianza:</span>
                <span class="text-purple-600">${trace.confidence || 'N/A'}</span>
            </div>
            <div>
                <span class="font-semibold">RAG Hits:</span>
                <span class="text-orange-600">${trace.rag_hits || 0}</span>
            </div>
            ${trace.rag_results && trace.rag_results.length > 0 ? `
            <div class="mt-3">
                <span class="font-semibold block mb-2">Documentos encontrados:</span>
                <div class="space-y-1">
                    ${trace.rag_results.map(r => `
                        <div class="text-xs p-2 bg-gray-50 rounded">
                            <div class="font-medium">${r.source} (${r.score.toFixed(3)})</div>
                            <div class="text-gray-600">${r.text}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
        </div>
    `;
    
    debugInfo.innerHTML = html;
}
</script>
{% endblock %}